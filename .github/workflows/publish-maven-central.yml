name: Publish to Maven Central

on:
  release:
    types: [created]
  workflow_dispatch:  # Permet de dÃ©clencher manuellement

jobs:
  build-rust:
    name: Build Rust Library
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache Rust dependencies
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build Rust library
        run: |
          cargo build --release --lib
          mkdir -p java/target/classes/linux-x86-64
          cp target/release/libsecure_memory.so java/target/classes/linux-x86-64/

      - name: Upload Rust artifacts
        uses: actions/upload-artifact@v3
        with:
          name: rust-library
          path: java/target/classes/linux-x86-64/libsecure_memory.so

  publish:
    name: Publish to Maven Central
    needs: build-rust
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven
          server-id: ossrh  # Value of the distributionManagement/repository/id field in pom.xml
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: MAVEN_GPG_PASSPHRASE

      - name: Download Rust artifacts
        uses: actions/download-artifact@v3
        with:
          name: rust-library
          path: java/target/classes/linux-x86-64

      - name: Verify native library
        run: |
          ls -la java/target/classes/linux-x86-64/
          file java/target/classes/linux-x86-64/libsecure_memory.so

      - name: Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

      - name: Publish to Maven Central
        working-directory: java
        env:
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
          MAVEN_GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          mvn -B clean deploy -P release \
            -DskipTests \
            -Dgpg.passphrase="${MAVEN_GPG_PASSPHRASE}"

      - name: Create GitHub Release Assets
        if: github.event_name == 'release'
        working-directory: java
        run: |
          cp target/secure-memory-java-*.jar ../
          cp target/secure-memory-java-*-sources.jar ../
          cp target/secure-memory-java-*-javadoc.jar ../

      - name: Upload Release Assets
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: |
            secure-memory-java-*.jar
            secure-memory-java-*-sources.jar
            secure-memory-java-*-javadoc.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Notify success
        if: success()
        run: |
          echo "âœ… Successfully published to Maven Central!"
          echo "ðŸ“¦ Group ID: io.github.pilougit.security"
          echo "ðŸ“¦ Artifact ID: secure-memory-java"
          echo "ðŸ“¦ Version: $(mvn help:evaluate -Dexpression=project.version -q -DforceStdout -f java/pom.xml)"
